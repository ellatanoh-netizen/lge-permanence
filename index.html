<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LGE - Droit et Justice | Permanence Op√©rationnelle</title>
    <style>
        /* ----- VARIABLES & RESET ----- */
        :root {
            --lge-green: #2e7d32;
            --lge-green-light: #e8f5e9;
            --lge-green-dark: #1b5e20;
            --amber: #d97706;
            --bg: #f8fafc;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --white: #ffffff;
            --border: #e2e8f0;
            --radius-lg: 24px;
            --radius-md: 16px;
            --radius-sm: 12px;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.05);
            --shadow-lg: 0 20px 30px -10px rgba(0,0,0,0.1);
            --transition: all 0.2s ease;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text-primary);
            line-height: 1.5;
            min-height: 100vh;
        }
        /* ----- UTILITAIRES ----- */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 0.5rem; }
        .gap-4 { gap: 1rem; }
        .p-4 { padding: 1rem; }
        .p-6 { padding: 1.5rem; }
        .p-8 { padding: 2rem; }
        .mt-4 { margin-top: 1rem; }
        .mb-4 { margin-bottom: 1rem; }
        .text-sm { font-size: 0.875rem; }
        .text-xs { font-size: 0.75rem; }
        .font-bold { font-weight: 700; }
        .font-semibold { font-weight: 600; }
        .text-muted { color: var(--text-secondary); }
        /* ----- COMPOSANTS ----- */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 0.95rem;
            border: none;
            cursor: pointer;
            transition: var(--transition);
            background-color: var(--white);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        .btn-primary {
            background-color: var(--lge-green);
            color: white;
            border: none;
            box-shadow: 0 2px 8px rgba(46,125,50,0.2);
        }
        .btn-primary:hover {
            background-color: var(--lge-green-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(46,125,50,0.3);
        }
        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
        }
        .btn-outline:hover {
            background: #f1f5f9;
        }
        .card {
            background-color: var(--white);
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
        }
        .card:hover {
            box-shadow: var(--shadow-md);
        }
        .input, .select, textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1.5px solid var(--border);
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 0.95rem;
            transition: var(--transition);
            background-color: var(--white);
        }
        .input:focus, .select:focus, textarea:focus {
            outline: none;
            border-color: var(--lge-green);
            box-shadow: 0 0 0 3px rgba(46,125,50,0.1);
        }
        label {
            font-weight: 600;
            font-size: 0.9rem;
            display: block;
            margin-bottom: 0.4rem;
            color: var(--text-primary);
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
        }
        .section-title {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 700;
            color: var(--lge-green);
            margin-bottom: 1.5rem;
            background: var(--lge-green-light);
            display: inline-block;
            padding: 0.3rem 1rem;
            border-radius: 20px;
        }
        /* ----- LAYOUT ----- */
        #login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 2rem;
            background: radial-gradient(circle at 10% 20%, #f0fdf4, #f8fafc);
        }
        .login-card {
            max-width: 480px;
            width: 100%;
            background: var(--white);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-lg);
        }
        .login-header {
            background: var(--lge-green);
            color: white;
            padding: 3rem 2rem;
            text-align: center;
        }
        .login-body {
            padding: 2.5rem 2rem;
        }
        /* dashboard */
        .app-header {
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(12px);
            padding: 1rem 2rem;
            border-bottom: 2px solid var(--lge-green);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 50;
        }
        .container {
            max-width: 1280px;
            margin: 2rem auto;
            padding: 0 2rem;
        }
        .session-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
            background: var(--white);
            padding: 1rem 1.5rem;
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            margin-bottom: 2rem;
            font-size: 0.9rem;
        }
        .badge {
            background: var(--lge-green-light);
            color: var(--lge-green-dark);
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.8rem;
        }
        .action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }
        .action-card {
            display: block;
            text-decoration: none;
            color: inherit;
            background: var(--white);
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            padding: 1.8rem 1.5rem;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }
        .action-card:hover {
            transform: translateY(-4px);
            border-color: var(--lge-green);
            box-shadow: var(--shadow-lg);
        }
        .action-card::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--border);
            transition: background 0.2s;
        }
        .action-card:hover::after {
            background: var(--lge-green);
        }
        .action-title {
            font-weight: 700;
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
        }
        .action-desc {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        /* modales */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15,23,42,0.3);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1.5rem;
        }
        .modal-container {
            background: var(--white);
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: modalFadeIn 0.2s ease;
        }
        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .modal-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--white);
            z-index: 10;
        }
        .modal-header h2 {
            font-size: 1.5rem;
            font-weight: 700;
        }
        .close-btn {
            background: #f1f5f9;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: var(--transition);
        }
        .close-btn:hover {
            background: #e2e8f0;
        }
        .modal-body {
            padding: 2rem;
        }
        .form-section {
            margin-bottom: 2.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
        }
        .form-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 500;
            cursor: pointer;
        }
        .checkbox-label input[type="checkbox"] {
            width: 1.2rem;
            height: 1.2rem;
            accent-color: var(--lge-green);
        }
        .btn-logout {
            width: 100%;
            padding: 1rem;
            background: #fff;
            color: #ef4444;
            border: 2px solid #fee2e2;
            border-radius: var(--radius-md);
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
            transition: var(--transition);
            margin: 3rem 0 1rem;
        }
        .btn-logout:hover {
            background: #fee2e2;
        }
        @media (max-width: 640px) {
            .container { padding: 0 1rem; }
            .app-header { padding: 1rem; }
            .modal-header { padding: 1rem 1.5rem; }
            .modal-body { padding: 1.5rem; }
            .form-grid { grid-template-columns: 1fr; }
        }
    </style>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>

    <!-- √âCRAN DE CONNEXION -->
    <div id="login-screen">
        <div class="login-card">
            <div class="login-header">
                <img src="https://lgedroitetjustice.fr/wp-content/uploads/2025/05/cropped-cropped-LOGO-2-282x300.png" height="90" alt="Logo LGE" style="filter: brightness(0) invert(1);">
                <h1 style="margin-top:1.5rem; font-weight:800; font-size:1.8rem;">LES GRAINES DE L'ESPOIR</h1>
                <p style="opacity:0.9; font-size:1rem;">Portail de Permanence</p>
            </div>
            <div class="login-body">
                <form id="login-form" onsubmit="demarrerPermanence(event)">
                    <div class="form-group">
                        <label>Email du b√©n√©vole</label>
                        <input type="email" id="email-input" class="input" placeholder="prenom.nom@lge.fr" required>
                    </div>
                    <div class="form-group">
                        <label>Type de permanence</label>
                        <select id="permanence-type" class="select" required>
                            <option value="classique">Permanence Classique</option>
                            <option value="mobile_juridique">Permanence Mobile Juridique</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width:100%; margin-top:1rem;">Lancer la session</button>
                </form>
            </div>
        </div>
    </div>

    <!-- DASHBOARD PRINCIPAL -->
    <div id="dashboard" class="hidden">
        <header class="app-header">
            <div class="flex items-center gap-4">
                <img src="https://lgedroitetjustice.fr/wp-content/uploads/2025/05/cropped-cropped-LOGO-2-282x300.png" height="40" alt="LGE">
                <span class="font-bold" style="font-size:1.2rem;">PERMANENCE OP√âRATIONNELLE</span>
            </div>
            <div id="live-clock" class="text-right">
                <div id="date-now" class="text-xs text-muted uppercase"></div>
                <div id="time-now" class="font-bold text-lge-green" style="font-size:1.2rem;"></div>
            </div>
        </header>

        <div class="container">
            <!-- Infos session -->
            <div class="session-info">
                <div class="flex items-center gap-2">
                    <span class="badge" id="user-display"></span>
                    <span class="text-sm text-muted">Connect√©(e)</span>
                </div>
                <div class="flex items-center gap-2">
                    <span>üïí D√©but :</span>
                    <span class="font-semibold" id="start-time-display"></span>
                </div>
                <div class="flex items-center gap-2">
                    <span>üìã Type :</span>
                    <span class="font-semibold" id="permanence-type-display"></span>
                </div>
            </div>

            <!-- DASHBOARD CLASSIQUE -->
            <div id="dashboard-classique" class="hidden">
                <div class="action-grid">
                    <div onclick="openFicheContact()" class="action-card" style="cursor:pointer;">
                        <div class="action-title">üìã Nouvelle fiche contact</div>
                        <div class="action-desc">Enregistrer une interaction (b√©n√©ficiaire, partenaire, etc.)</div>
                    </div>
                    <!-- NOUVELLE CARTE POUR LA FICHE JURIDIQUE APPROFONDIE -->
                    <div onclick="openFicheJuridique()" class="action-card" style="cursor:pointer; border-color: #9c27b0;">
                        <div class="action-title">‚öñÔ∏è Fiche juridique approfondie</div>
                        <div class="action-desc">Dossier complet (violences, famille, travail, asile...)</div>
                    </div>
                    <a href="https://docs.google.com/spreadsheets/d/1HHgQbhCWtAS_LD93yFf9JncpuvCoXVod112bTr5wYmo/edit?usp=sharing" target="_blank" class="action-card">
                        <div class="action-title">üìû Annuaire interne</div>
                        <div class="action-desc">Contacts p√¥les et partenaires</div>
                    </a>
                    <a href="https://forms.gle/efW4RKVZF3tnEFts8" target="_blank" class="action-card">
                        <div class="action-title">üìù Compte-rendu de vacation</div>
                        <div class="action-desc">Bilan de fin de permanence</div>
                    </a>
                    <a href="https://drive.google.com/file/d/1ECDdNKRRwPsh5LN5Jq9xRC-cx6rvpOXz/view" target="_blank" class="action-card">
                        <div class="action-title">‚öñÔ∏è Protocole op√©rationnel</div>
                        <div class="action-desc">Cadre et proc√©dures</div>
                    </a>
                    <a href="https://calendar.app.google/vmuAcu8KPvzkd5vC8" target="_blank" class="action-card">
                        <div class="action-title">üìÖ R√©server un cr√©neau</div>
                        <div class="action-desc">Maison des Associations</div>
                    </a>
                    <!-- Lien CARELINE WhatsApp -->
                    <a href="https://wa.me/33784812030" target="_blank" class="action-card" style="border-color: #25D366;">
                        <div class="action-title">üì± CARELINE WhatsApp</div>
                        <div class="action-desc">Contacter l'√©quipe soutien</div>
                    </a>
                </div>
            </div>

            <!-- DASHBOARD MOBILE JURIDIQUE -->
            <div id="dashboard-mobile" class="hidden">
                <div class="action-grid">
                    <div onclick="openFicheMobile()" class="action-card" style="cursor:pointer;">
                        <div class="action-title">‚öñÔ∏è Dossier mobile juridique</div>
                        <div class="action-desc">Nouvelle intervention itin√©rante</div>
                    </div>
                    <a href="https://docs.google.com/spreadsheets/d/1HHgQbhCWtAS_LD93yFf9JncpuvCoXVod112bTr5wYmo/edit?usp=sharing" target="_blank" class="action-card">
                        <div class="action-title">üìû Annuaire juridique</div>
                        <div class="action-desc">Avocats, p√¥les, partenaires</div>
                    </a>
                    <a href="https://drive.google.com/file/d/1CiJANqE4y4xSXFPU842kEH-B6KxNVoL1/view" target="_blank" class="action-card">
                        <div class="action-title">‚öñÔ∏è Protocole mobile</div>
                        <div class="action-desc">Proc√©dure unit√© mobile</div>
                    </a>
                    <a href="https://drive.google.com/file/d/1FIsLRBXEMoAzB21MkjwstZ-WUueROhuD/view" target="_blank" class="action-card">
                        <div class="action-title">üó∫Ô∏è Guide mobiles</div>
                        <div class="action-desc">Gestion itin√©rante</div>
                    </a>
                    <a href="#" id="booking-mobile-link" target="_blank" class="action-card">
                        <div class="action-title">üìå R√©server un cr√©neau</div>
                        <div class="action-desc">Tourn√©e mobile</div>
                    </a>
                    <!-- Lien CARELINE WhatsApp aussi pour mobile -->
                    <a href="https://wa.me/33784812030" target="_blank" class="action-card" style="border-color: #25D366;">
                        <div class="action-title">üì± CARELINE WhatsApp</div>
                        <div class="action-desc">Contacter l'√©quipe soutien</div>
                    </a>
                </div>
            </div>

            <button class="btn-logout" onclick="confirmerDeconnexion()">Terminer la permanence</button>
        </div>
    </div>

    <!-- MODALE FICHE CONTACT (intelligente) -->
    <div id="modal-fiche-contact" class="modal-overlay hidden">
        <div class="modal-container">
            <div class="modal-header">
                <h2>üìã Nouvelle fiche contact</h2>
                <button class="close-btn" onclick="closeFicheContact()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="form-fiche-contact" onsubmit="submitFicheContact(event)">
                    <!-- Section: R√©f√©rences -->
                    <div class="form-section">
                        <div class="section-title">01 ‚Äî R√©f√©rences</div>
                        <div class="form-grid">
                            <div>
                                <label>ID Fiche <span class="text-muted">(auto)</span></label>
                                <input type="text" id="contact-id" readonly class="input" style="background:#f1f5f9;">
                            </div>
                            <div>
                                <label>Nature</label>
                                <select id="contact-nature" class="select">
                                    <option value="Premier contact">Premier contact</option>
                                    <option value="Suivi">Suivi</option>
                                </select>
                            </div>
                        </div>
                        <div id="prev-id-container" class="hidden" style="margin-top:1rem;">
                            <label>ID fiche pr√©c√©dente</label>
                            <input type="text" id="contact-prev-id" class="input">
                        </div>
                    </div>

                    <!-- Section: Type de demande (conditionne la suite) -->
                    <div class="form-section">
                        <div class="section-title">02 ‚Äî Type de demande</div>
                        <div>
                            <label>Cat√©gorie</label>
                            <select id="contact-categorie" class="select" onchange="categorieChange()" required>
                                <option value="">-- S√©lectionnez --</option>
                                <option value="beneficiaire">B√©n√©ficiaire (demande d'aide)</option>
                                <option value="partenaire">Partenaire / Prescripteur</option>
                                <option value="benevole">Candidat b√©n√©vole</option>
                                <option value="information">Demande d'information</option>
                            </select>
                        </div>
                    </div>

                    <!-- Section: Informations communes (toujours affich√©es) -->
                    <div class="form-section">
                        <div class="section-title">03 ‚Äî Coordonn√©es</div>
                        <div class="form-grid">
                            <div>
                                <label>Nom / Pr√©nom ou Structure</label>
                                <input type="text" id="contact-nom" class="input" required>
                            </div>
                            <div>
                                <label>T√©l√©phone</label>
                                <input type="tel" id="contact-tel" class="input">
                            </div>
                            <div>
                                <label>Email</label>
                                <input type="email" id="contact-email" class="input">
                            </div>
                        </div>
                    </div>

                    <!-- Section B√©n√©ficiaire (conditionnelle) -->
                    <div id="section-beneficiaire" class="form-section hidden">
                        <div class="section-title">04 ‚Äî Informations sociales (b√©n√©ficiaire)</div>
                        <div class="form-grid">
                            <div>
                                <label>Situation professionnelle</label>
                                <select id="benef-situation-pro" class="select">
                                    <option value="">-- S√©lectionnez --</option>
                                    <option>Sans emploi</option>
                                    <option>CDI/CDD</option>
                                    <option>Ind√©pendant</option>
                                    <option>√âtudiant</option>
                                    <option>Retrait√©</option>
                                </select>
                            </div>
                            <div>
                                <label>Ressources</label>
                                <select id="benef-ressources" class="select">
                                    <option>Aucune</option>
                                    <option>Minima sociaux (RSA, AAH)</option>
                                    <option>< SMIC</option>
                                    <option>> SMIC</option>
                                </select>
                            </div>
                            <div>
                                <label>Nombre d'enfants √† charge</label>
                                <input type="number" id="benef-enfants" class="input" min="0" value="0">
                            </div>
                        </div>
                        <div style="margin-top:1rem;">
                            <label>Situation administrative</label>
                            <select id="benef-situation-admin" class="select">
                                <option value="">-- S√©lectionnez --</option>
                                <option>Europ√©en (UE)</option>
                                <option>Titre de s√©jour valide</option>
                                <option>R√©c√©piss√©</option>
                                <option>Demande d'asile</option>
                                <option>Sans titre (OQTF)</option>
                            </select>
                        </div>
                        <div style="margin-top:1rem;">
                            <label>Nature de la demande</label>
                            <textarea id="benef-demande" class="input" rows="2" placeholder="D√©crire bri√®vement la demande..."></textarea>
                        </div>
                        <div style="margin-top:1rem;">
                            <label>Orientation propos√©e</label>
                            <select id="benef-orientation" class="select">
                                <option value="">-- S√©lectionnez --</option>
                                <option>Juridique</option>
                                <option>Psychologique</option>
                                <option>Social</option>
                                <option>KOOM</option>
                                <option>CARELINE</option>
                                <option>Collectes</option>
                                <option>Autre</option>
                            </select>
                        </div>
                        <!-- Champ Urgence -->
                        <div style="margin-top:1rem;">
                            <label>Niveau d'urgence</label>
                            <select id="benef-urgence" class="select">
                                <option value="Faible">Faible</option>
                                <option value="Moyenne">Moyenne</option>
                                <option value="Haute">Haute</option>
                            </select>
                        </div>
                    </div>

                    <!-- Section Partenaire (conditionnelle) avec les nouveaux champs -->
                    <div id="section-partenaire" class="form-section hidden">
                        <div class="section-title">04 ‚Äî Informations partenaire</div>
                        <div class="form-grid">
                            <div>
                                <label>Nom de la structure</label>
                                <input type="text" id="partenaire-structure" class="input">
                            </div>
                            <div>
                                <label>Type de structure</label>
                                <select id="partenaire-type" class="select">
                                    <option>Association</option>
                                    <option>Service public</option>
                                    <option>Entreprise</option>
                                    <option>Autre</option>
                                </select>
                            </div>
                            <div>
                                <label>Personne de contact (pr√©nom/nom)</label>
                                <input type="text" id="partenaire-contact" class="input">
                            </div>
                        </div>
                        <div style="margin-top:1rem;">
                            <label>Nature du partenariat</label>
                            <textarea id="partenaire-nature" class="input" rows="2" placeholder="Ex: convention, orientation mutuelle, mise √† disposition..."></textarea>
                        </div>
                        <!-- NOUVEAUX CHAMPS PARTENAIRE -->
                        <div style="margin-top:1rem;">
                            <label>Partenariat act√© ?</label>
                            <select id="partenaire-acte" class="select">
                                <option value="non">Non</option>
                                <option value="oui">Oui</option>
                                <option value="en_cours">En cours de validation</option>
                            </select>
                        </div>
                        <div style="margin-top:1rem;">
                            <label>Horaires de permanence du partenaire</label>
                            <input type="text" id="partenaire-horaires" class="input" placeholder="ex: lundi 14h-17h, jeudi 9h-12h">
                        </div>
                        <div style="margin-top:1rem;">
                            <label>Informations compl√©mentaires</label>
                            <textarea id="partenaire-infos" class="input" rows="2" placeholder="Contact direct, modalit√©s d'orientation..."></textarea>
                        </div>
                    </div>

                    <!-- Section Candidat b√©n√©vole (conditionnelle) -->
                    <div id="section-benevole" class="form-section hidden">
                        <div class="section-title">04 ‚Äî Informations candidat b√©n√©vole</div>
                        <div class="form-grid">
                            <div>
                                <label>√Çge</label>
                                <input type="number" id="benevole-age" class="input" min="18">
                            </div>
                            <div>
                                <label>Profession / Comp√©tences</label>
                                <input type="text" id="benevole-competences" class="input">
                            </div>
                        </div>
                        <div style="margin-top:1rem;">
                            <label>Disponibilit√©s</label>
                            <input type="text" id="benevole-dispo" class="input" placeholder="ex: mercredi apr√®s-midi">
                        </div>
                        <div style="margin-top:1rem;">
                            <label>Mission souhait√©e</label>
                            <select id="benevole-mission" class="select">
                                <option>Accueil / Administration</option>
                                <option>Juridique</option>
                                <option>Terrain / Collectes</option>
                                <option>Communication</option>
                                <option>Autre</option>
                            </select>
                        </div>
                    </div>

                    <!-- Section Information simple (conditionnelle) -->
                    <div id="section-information" class="form-section hidden">
                        <div class="section-title">04 ‚Äî Demande d'information</div>
                        <div>
                            <label>Sujet de la demande</label>
                            <input type="text" id="info-sujet" class="input">
                        </div>
                        <div style="margin-top:1rem;">
                            <label>R√©ponse apport√©e / informations transmises</label>
                            <textarea id="info-reponse" class="input" rows="2"></textarea>
                        </div>
                    </div>

                    <!-- Section: Validation -->
                    <div class="form-section">
                        <div class="section-title">05 ‚Äî Validation</div>
                        <label class="checkbox-label">
                            <input type="checkbox" id="contact-valid" required>
                            <span>Je certifie l'exactitude des informations et atteste avoir recueilli le consentement de la personne (RGPD).</span>
                        </label>
                    </div>

                    <div style="display: flex; gap:1rem; justify-content: flex-end;">
                        <button type="button" class="btn btn-outline" onclick="closeFicheContact()">Annuler</button>
                        <button type="submit" class="btn btn-primary">Enregistrer la fiche</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODALE FICHE JURIDIQUE APPROFONDIE (nouvelle) -->
    <div id="modal-fiche-juridique" class="modal-overlay hidden">
        <div class="modal-container">
            <div class="modal-header">
                <h2>‚öñÔ∏è Fiche juridique approfondie</h2>
                <button class="close-btn" onclick="closeFicheJuridique()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="form-fiche-juridique" onsubmit="submitFicheJuridique(event)">
                    <!-- R√©f√©rences -->
                    <div class="form-section">
                        <div class="section-title">01 ‚Äî R√©f√©rences</div>
                        <div class="form-grid">
                            <div><label>ID Fiche</label><input type="text" id="juridique-id" readonly class="input" style="background:#f1f5f9;"></div>
                            <div><label>Nature</label><select id="juridique-nature" class="select"><option>Premier contact</option><option>Suivi</option></select></div>
                        </div>
                        <div id="juridique-prev-container" class="hidden" style="margin-top:1rem;"><label>ID pr√©c√©dent</label><input type="text" id="juridique-prev-id" class="input"></div>
                    </div>
                    <!-- Identit√© -->
                    <div class="form-section">
                        <div class="section-title">02 ‚Äî Identit√©</div>
                        <div class="form-grid">
                            <div><label>Nom</label><input type="text" id="juridique-nom" class="input" required></div>
                            <div><label>Pr√©nom</label><input type="text" id="juridique-prenom" class="input"></div>
                            <div><label>Date naissance</label><input type="date" id="juridique-date-naissance" class="input"></div>
                            <div><label>Lieu naissance</label><input type="text" id="juridique-lieu-naissance" class="input"></div>
                            <div><label>Nationalit√©</label><input type="text" id="juridique-nationalite" class="input"></div>
                            <div><label>Pays provenance</label><input type="text" id="juridique-pays-provenance" class="input"></div>
                            <div><label>T√©l√©phone</label><input type="tel" id="juridique-tel" class="input"></div>
                            <div><label>Email</label><input type="email" id="juridique-email" class="input"></div>
                            <div><label>Date RDV</label><input type="date" id="juridique-date-rdv" class="input"></div>
                            <div><label>B√©n√©vole r√©f√©rent</label><input type="text" id="juridique-benevole-ref" class="input"></div>
                            <div><label>N¬∞ Dossier</label><input type="text" id="juridique-numero-dossier" class="input"></div>
                            <div><label>Situation logement</label><select id="juridique-logement" class="select"><option>Logement stable</option><option>H√©berg√©</option><option>H√¥tel social</option><option>Rue</option></select></div>
                        </div>
                    </div>
                    <!-- Arriv√©e & famille -->
                    <div class="form-section">
                        <div class="section-title">03 ‚Äî Arriv√©e et situation familiale</div>
                        <div class="form-grid">
                            <div><label><input type="checkbox" id="juridique-arrivee-visa"> Arriv√©e avec visa</label></div>
                            <div><label><input type="checkbox" id="juridique-arrivee-sans-visa"> Arriv√©e sans visa</label></div>
                            <div><label>Date entr√©e</label><input type="date" id="juridique-date-entree" class="input"></div>
                            <div><label>Fronti√®re entr√©e</label><input type="text" id="juridique-frontiere" class="input"></div>
                            <div><label>Visas pass√©s</label><input type="text" id="juridique-visas-passes" class="input"></div>
                            <div><label><input type="checkbox" id="juridique-conjoint-fr"> Conjoint fran√ßais</label></div>
                            <div><label><input type="checkbox" id="juridique-conjoint-regulier"> Conjoint √©tranger r√©gulier</label></div>
                            <div><label><input type="checkbox" id="juridique-conjoint-irregulier"> Conjoint √©tranger irr√©gulier</label></div>
                            <div><label>Date mariage</label><input type="date" id="juridique-date-mariage" class="input"></div>
                            <div><label>Lieu mariage</label><input type="text" id="juridique-lieu-mariage" class="input"></div>
                            <div><label><input type="checkbox" id="juridique-a-enfants"> A des enfants</label></div>
                            <div><label><input type="checkbox" id="juridique-enfants-france"> Enfants n√©s en France</label></div>
                            <div><label><input type="checkbox" id="juridique-enfant-francais"> Au moins un enfant fran√ßais</label></div>
                        </div>
                        <!-- Tableau des enfants (simplifi√©, on peut stocker en JSON plus tard) -->
                        <div style="margin-top:1rem;">
                            <label>D√©tails des enfants (pr√©nom, date naissance, lieu, nationalit√©, scolaris√©, vit avec vous) ‚Äì √† remplir en texte libre pour simplifier</label>
                            <textarea id="juridique-enfants-details" class="input" rows="3" placeholder="Ex: Emma, 15/03/2018, Paris, fran√ßaise, scolaris√©e, vit avec moi"></textarea>
                        </div>
                    </div>
                    <!-- Situation administrative -->
                    <div class="form-section">
                        <div class="section-title">04 ‚Äî Situation administrative</div>
                        <div class="form-grid">
                            <div><label><input type="checkbox" id="juridique-a-deja-titre"> A d√©j√† eu titre de s√©jour</label></div>
                            <div><label>Titres pr√©c√©dents</label><input type="text" id="juridique-titres-precedents" class="input"></div>
                            <div><label><input type="checkbox" id="juridique-recipisse"> R√©c√©piss√© en cours</label></div>
                            <div><label>N¬∞ r√©c√©piss√©</label><input type="text" id="juridique-numero-recipisse" class="input"></div>
                            <div><label><input type="checkbox" id="juridique-oqtf"> OQTF re√ßue</label></div>
                            <div><label>Date OQTF</label><input type="date" id="juridique-date-oqtf" class="input"></div>
                            <div><label><input type="checkbox" id="juridique-recours"> Recours exerc√©</label></div>
                            <div><label><input type="checkbox" id="juridique-refus"> Refus de s√©jour</label></div>
                            <div><label>Date refus</label><input type="date" id="juridique-date-refus" class="input"></div>
                            <div><label>Motif refus</label><input type="text" id="juridique-motif-refus" class="input"></div>
                            <div><label><input type="checkbox" id="juridique-convocation"> Convocation pr√©fecture</label></div>
                            <div><label>Date convocation</label><input type="date" id="juridique-date-convocation" class="input"></div>
                            <div><label>N¬∞ dossier pr√©fecture</label><input type="text" id="juridique-numero-dossier-pref" class="input"></div>
                            <div><label>Autre mesure</label><input type="text" id="juridique-autre-mesure" class="input"></div>
                        </div>
                    </div>
                    <!-- Travail -->
                    <div class="form-section">
                        <div class="section-title">05 ‚Äî Travail</div>
                        <div class="form-grid">
                            <div><label><input type="checkbox" id="juridique-travail-declare"> Travail d√©clar√©</label></div>
                            <div><label><input type="checkbox" id="juridique-travail-non-declare"> Travail non d√©clar√©</label></div>
                            <div><label>Secteur activit√©</label><input type="text" id="juridique-secteur" class="input"></div>
                            <div><label>Anciennet√© (ann√©es)</label><input type="number" id="juridique-anciennete" class="input"></div>
                            <div><label>Employeur</label><input type="text" id="juridique-employeur" class="input"></div>
                            <div><label>Salaire mensuel net</label><input type="text" id="juridique-salaire" class="input"></div>
                            <div><label>Temps travail (h/sem)</label><input type="text" id="juridique-temps-travail" class="input"></div>
                            <div><label>Type contrat</label><select id="juridique-type-contrat" class="select"><option>CDI</option><option>CDD</option><option>Int√©rim</option><option>Saisonnier</option></select></div>
                            <div><label><input type="checkbox" id="juridique-promesse"> Promesse d'embauche</label></div>
                            <div><label>Preuves travail</label><input type="text" id="juridique-preuves-travail" class="input" placeholder="ex: bulletins, contrat..."></div>
                        </div>
                    </div>
                    <!-- Violences -->
                    <div class="form-section" style="border-left: 4px solid #dc2626;">
                        <div class="section-title">üî¥ 06 ‚Äî Violences</div>
                        <div class="form-grid">
                            <div><label><input type="checkbox" id="juridique-victime-violences"> Victime de violences</label></div>
                            <div><label>Auteur</label><input type="text" id="juridique-auteur-violences" class="input" placeholder="conjoint/ex/autre"></div>
                            <div><label>Nature violences</label><input type="text" id="juridique-nature-violences" class="input" placeholder="physiques, psychologiques..."></div>
                            <div><label>P√©riode</label><input type="text" id="juridique-periode-violences" class="input" placeholder="de ... √† ..."></div>
                            <div><label><input type="checkbox" id="juridique-plainte"> Plainte d√©pos√©e</label></div>
                            <div><label>Lieu plainte</label><input type="text" id="juridique-lieu-plainte" class="input"></div>
                            <div><label><input type="checkbox" id="juridique-ordonnance"> Ordonnance de protection</label></div>
                            <div><label>Juge & dur√©e</label><input type="text" id="juridique-juge-duree" class="input"></div>
                            <div><label><input type="checkbox" id="juridique-certificats"> Certificats m√©dicaux</label></div>
                            <div><label>Dates certificats</label><input type="text" id="juridique-dates-certificats" class="input"></div>
                            <div><label><input type="checkbox" id="juridique-separee"> S√©par√©e de l'auteur</label></div>
                            <div><label>Autres preuves</label><input type="text" id="juridique-autres-preuves" class="input"></div>
                            <div><label>Suivi association</label><input type="text" id="juridique-suivi-association" class="input"></div>
                            <div><label><input type="checkbox" id="juridique-enfants-concernes"> Enfants concern√©s</label></div>
                        </div>
                    </div>
                    <!-- Autres crit√®res -->
                    <div class="form-section">
                        <div class="section-title">07 ‚Äî Autres crit√®res</div>
                        <div class="form-grid">
                            <div><label><input type="checkbox" id="juridique-parent-enfant-fr"> Parent d'enfant fran√ßais</label></div>
                            <div><label>Nom enfant</label><input type="text" id="juridique-nom-enfant-fr" class="input"></div>
                            <div><label>N¬∞ carte enfant</label><input type="text" id="juridique-numero-carte-enfant" class="input"></div>
                            <div><label>Preuves contribution</label><input type="text" id="juridique-preuves-contribution" class="input"></div>
                            <div><label><input type="checkbox" id="juridique-presence-ancienne"> Pr√©sence ancienne (‚â•10 ans)</label></div>
                            <div><label>Preuves pr√©sence</label><input type="text" id="juridique-preuves-presence" class="input"></div>
                            <div><label>Ann√©es manquantes</label><input type="text" id="juridique-annees-manquantes" class="input"></div>
                            <div><label><input type="checkbox" id="juridique-raisons-sante"> Raisons de sant√©</label></div>
                            <div><label>Maladie</label><input type="text" id="juridique-maladie" class="input"></div>
                            <div><label>Suivi m√©dical</label><input type="text" id="juridique-suivi-medical" class="input"></div>
                            <div><label><input type="checkbox" id="juridique-certificat-impossibilite"> Certificat mentionne impossibilit√© soins pays d'origine</label></div>
                            <div><label><input type="checkbox" id="juridique-demande-asile"> Demande d'asile d√©pos√©e</label></div>
                            <div><label>Date d√©p√¥t</label><input type="date" id="juridique-date-depot-asile" class="input"></div>
                            <div><label>D√©cision OFPRA</label><select id="juridique-decision-ofpra" class="select"><option>En cours</option><option>Accept√©e</option><option>Refus√©e</option></select></div>
                            <div><label>Liens familiaux France</label><input type="text" id="juridique-liens-familiaux" class="input"></div>
                            <div><label>Int√©gration</label><input type="text" id="juridique-integration" class="input" placeholder="cours de fran√ßais, b√©n√©volat..."></div>
                        </div>
                    </div>
                    <!-- Urgence -->
                    <div class="form-section">
                        <div class="section-title">üö® 08 ‚Äî Urgence</div>
                        <div class="form-grid">
                            <div><label><input type="checkbox" id="juridique-urgence-oqtf"> OQTF / recours urgent</label></div>
                            <div><label>√âvaluation danger (1-3)</label><select id="juridique-evaluation-danger" class="select"><option>1</option><option>2</option><option>3</option></select></div>
                            <div><label><input type="checkbox" id="juridique-danger-immediat"> Danger imm√©diat</label></div>
                            <div><label>Mesures protection</label><input type="text" id="juridique-mesures-protection" class="input"></div>
                            <div><label><input type="checkbox" id="juridique-hebergement-urgence"> H√©bergement d'urgence n√©cessaire</label></div>
                            <div><label>Contact urgence (nom/t√©l)</label><input type="text" id="juridique-contact-urgence" class="input"></div>
                        </div>
                    </div>
                    <!-- Documents (synth√®se) -->
                    <div class="form-section">
                        <div class="section-title">üìé 09 ‚Äî Documents apport√©s (r√©sum√©)</div>
                        <div>
                            <textarea id="juridique-documents-resume" class="input" rows="3" placeholder="Liste des documents fournis par la personne..."></textarea>
                        </div>
                    </div>
                    <!-- R√©sum√© automatique (champ texte g√©n√©r√© c√¥t√© serveur, ici on laisse vide) -->
                    <div class="form-section">
                        <div class="section-title">‚ú® 10 ‚Äî R√©sum√© automatique (g√©n√©r√© c√¥t√© serveur)</div>
                        <div>
                            <textarea id="juridique-resume-auto" class="input" rows="3" readonly placeholder="Sera g√©n√©r√© automatiquement par le script"></textarea>
                        </div>
                    </div>
                    <!-- Orientation et notes -->
                    <div class="form-section">
                        <div class="section-title">üìå 11 ‚Äî Orientation & notes</div>
                        <div>
                            <label>Orientation propos√©e</label>
                            <input type="text" id="juridique-orientation" class="input">
                        </div>
                        <div style="margin-top:1rem;">
                            <label>Notes compl√©mentaires</label>
                            <textarea id="juridique-notes" class="input" rows="3"></textarea>
                        </div>
                    </div>
                    <!-- Validation RGPD -->
                    <div class="form-section">
                        <div class="section-title">12 ‚Äî Validation</div>
                        <label class="checkbox-label">
                            <input type="checkbox" id="juridique-valid" required>
                            <span>Je certifie l'exactitude des informations et atteste avoir recueilli le consentement (RGPD).</span>
                        </label>
                    </div>

                    <div style="display: flex; gap:1rem; justify-content: flex-end;">
                        <button type="button" class="btn btn-outline" onclick="closeFicheJuridique()">Annuler</button>
                        <button type="submit" class="btn btn-primary">Enregistrer la fiche</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODALE FICHE MOBILE JURIDIQUE (inchang√©e) -->
    <div id="modal-fiche-mobile" class="modal-overlay hidden">
        <div class="modal-container">
            <div class="modal-header">
                <h2>‚öñÔ∏è Dossier mobile juridique</h2>
                <button class="close-btn" onclick="closeFicheMobile()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="form-fiche-mobile" onsubmit="submitFicheMobile(event)">
                    <!-- Section: R√©f√©rences -->
                    <div class="form-section">
                        <div class="section-title">01 ‚Äî R√©f√©rences</div>
                        <div class="form-grid">
                            <div>
                                <label>ID Dossier</label>
                                <input type="text" id="mobile-id" readonly class="input" style="background:#f1f5f9;">
                            </div>
                            <div>
                                <label>Nature</label>
                                <select id="mobile-nature" class="select">
                                    <option>Premier contact</option>
                                    <option>Suivi</option>
                                </select>
                            </div>
                        </div>
                        <div id="mobile-prev-container" class="hidden" style="margin-top:1rem;">
                            <label>ID Dossier pr√©c√©dent</label>
                            <input type="text" id="mobile-prev-id" class="input">
                        </div>
                        <div style="margin-top:1rem;">
                            <label>Intervenant¬∑e principal¬∑e</label>
                            <input type="text" id="mobile-intervenant" class="input" required>
                        </div>
                    </div>

                    <!-- Section: Coordonn√©es -->
                    <div class="form-section">
                        <div class="section-title">02 ‚Äî Personne accompagn√©e</div>
                        <div class="form-grid">
                            <div>
                                <label>Nom / Pr√©nom</label>
                                <input type="text" id="mobile-nom" class="input" required>
                            </div>
                            <div>
                                <label>T√©l√©phone</label>
                                <input type="tel" id="mobile-tel" class="input">
                            </div>
                            <div>
                                <label>Email</label>
                                <input type="email" id="mobile-email" class="input">
                            </div>
                        </div>
                    </div>

                    <!-- Section: Profil -->
                    <div class="form-section">
                        <div class="section-title">03 ‚Äî Profil et situation</div>
                        <div class="form-grid">
                            <div>
                                <label>Situation professionnelle</label>
                                <select id="mobile-situation-pro" class="select">
                                    <option>Sans emploi</option>
                                    <option>Salari√©</option>
                                    <option>Ind√©pendant</option>
                                    <option>√âtudiant</option>
                                </select>
                            </div>
                            <div>
                                <label>Enfants √† charge</label>
                                <input type="number" id="mobile-enfants" class="input" min="0" value="0">
                            </div>
                        </div>
                        <div style="margin-top:1rem;">
                            <label>Situation administrative</label>
                            <select id="mobile-situation-admin" class="select" required>
                                <option value="">-- S√©lectionnez --</option>
                                <option>Europ√©en (UE)</option>
                                <option>Titre de s√©jour valide</option>
                                <option>R√©c√©piss√©</option>
                                <option>Demande d'asile</option>
                                <option>Sans titre (OQTF)</option>
                            </select>
                        </div>
                        <div style="margin-top:1rem;">
                            <label>Ressources</label>
                            <select id="mobile-ressources" class="select">
                                <option>Aucune</option>
                                <option>Minima sociaux</option>
                                <option>< SMIC</option>
                                <option>> SMIC</option>
                            </select>
                        </div>
                    </div>

                    <!-- Section: Juridique -->
                    <div class="form-section">
                        <div class="section-title">04 ‚Äî Dossier juridique</div>
                        <div class="form-grid">
                            <div>
                                <label>Th√©matique</label>
                                <select id="mobile-theme" class="select" required>
                                    <option>Famille</option>
                                    <option>Travail</option>
                                    <option>√âtrangers</option>
                                    <option>P√©nal</option>
                                    <option>Logement</option>
                                    <option>Consommation</option>
                                </select>
                            </div>
                            <div>
                                <label>Objet du litige</label>
                                <input type="text" id="mobile-objet" class="input" required>
                            </div>
                        </div>
                        <div style="margin-top:1rem;">
                            <label>Analyse confidentielle</label>
                            <textarea id="mobile-analyse" class="input" rows="3"></textarea>
                        </div>
                        <div style="margin-top:1rem;">
                            <label>√âtapes conseill√©es / actions r√©alis√©es</label>
                            <textarea id="mobile-etapes" class="input" rows="2"></textarea>
                        </div>
                        <div style="margin-top:1rem;">
                            <label>Aide juridictionnelle ?</label>
                            <select id="mobile-aj" class="select">
                                <option>Non</option>
                                <option>Demande en cours</option>
                                <option>Accord√©e</option>
                                <option>Refus√©e</option>
                            </select>
                        </div>
                        <div style="margin-top:1rem;">
                            <label>Structure relais (si orientation)</label>
                            <input type="text" id="mobile-relais" class="input" placeholder="Nom du partenaire">
                        </div>
                        <!-- Champ Urgence pour mobile -->
                        <div style="margin-top:1rem;">
                            <label>Niveau d'urgence</label>
                            <select id="mobile-urgence" class="select">
                                <option value="Faible">Faible</option>
                                <option value="Moyenne">Moyenne</option>
                                <option value="Haute">Haute</option>
                            </select>
                        </div>
                    </div>

                    <!-- Section: Validation RGPD -->
                    <div class="form-section">
                        <div class="section-title">05 ‚Äî Validation</div>
                        <label class="checkbox-label">
                            <input type="checkbox" id="mobile-valid" required>
                            <span>Je certifie l'exactitude des informations et atteste avoir recueilli le consentement (RGPD).</span>
                        </label>
                        <div style="margin-top:1rem;">
                            <label>Consentement RGPD</label>
                            <select id="mobile-rgpd" class="select">
                                <option>Consentement recueilli</option>
                                <option>Refus de consentement</option>
                            </select>
                        </div>
                    </div>

                    <div style="display: flex; gap:1rem; justify-content: flex-end;">
                        <button type="button" class="btn btn-outline" onclick="closeFicheMobile()">Annuler</button>
                        <button type="submit" class="btn btn-primary">Transmettre le dossier</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODALE FIN DE SESSION -->
    <div id="modal-logout" class="modal-overlay hidden">
        <div class="modal-container" style="max-width:480px; text-align:center; padding:2rem;">
            <h2 style="color: var(--lge-green); font-weight:800; margin-bottom:1rem;">Session termin√©e</h2>
            <p id="logout-summary" style="margin-bottom:2rem; color:var(--text-secondary);"></p>
            <button class="btn btn-primary" onclick="fermerTout()">Retour √† l'accueil</button>
        </div>
    </div>

    <script>
        // ================== CONFIG ==================
      const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzLk1Wryy2yGnr5qp3FcaqnWX319DiLIh_wzXXky5SINwElHG31tDOQUXgHRMDP_4zz/exec";

        // ================== GESTION DE L'HORLOGE ==================
        function updateClock() {
            const now = new Date();
            document.getElementById('date-now').innerText = now.toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric', month: 'short' });
            document.getElementById('time-now').innerText = now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
        }
        setInterval(updateClock, 1000);

        // ================== CONNEXION / SESSION ==================
        function demarrerPermanence(e) {
            e.preventDefault();
            const email = document.getElementById('email-input').value.trim();
            const type = document.getElementById('permanence-type').value;
            if (!email.includes('@')) {
                alert("Veuillez entrer un email valide.");
                return;
            }
            const now = new Date();
            localStorage.setItem('lge_email', email);
            localStorage.setItem('lge_start', now.toISOString());
            localStorage.setItem('lge_type', type);
            lancerInterface(email, now, type);
        }

        function lancerInterface(email, start, type) {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('user-display').innerText = email;
            document.getElementById('start-time-display').innerText = start.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('permanence-type-display').innerText = type === 'classique' ? 'Classique' : 'Mobile Juridique';

            if (type === 'classique') {
                document.getElementById('dashboard-classique').classList.remove('hidden');
                document.getElementById('dashboard-mobile').classList.add('hidden');
            } else {
                document.getElementById('dashboard-mobile').classList.remove('hidden');
                document.getElementById('dashboard-classique').classList.add('hidden');
            }
        }

        // ================== FICHE CONTACT (intelligente) ==================
        function openFicheContact() {
            document.getElementById('contact-id').value = 'FC-' + Date.now().toString().slice(-8);
            document.getElementById('modal-fiche-contact').classList.remove('hidden');
            resetFicheContact();
        }
        function closeFicheContact() {
            document.getElementById('modal-fiche-contact').classList.add('hidden');
        }
        function resetFicheContact() {
            document.getElementById('section-beneficiaire').classList.add('hidden');
            document.getElementById('section-partenaire').classList.add('hidden');
            document.getElementById('section-benevole').classList.add('hidden');
            document.getElementById('section-information').classList.add('hidden');
            document.getElementById('prev-id-container').classList.add('hidden');
            document.getElementById('contact-categorie').value = '';
        }
        function categorieChange() {
            const cat = document.getElementById('contact-categorie').value;
            document.getElementById('section-beneficiaire').classList.add('hidden');
            document.getElementById('section-partenaire').classList.add('hidden');
            document.getElementById('section-benevole').classList.add('hidden');
            document.getElementById('section-information').classList.add('hidden');
            if (cat === 'beneficiaire') {
                document.getElementById('section-beneficiaire').classList.remove('hidden');
            } else if (cat === 'partenaire') {
                document.getElementById('section-partenaire').classList.remove('hidden');
            } else if (cat === 'benevole') {
                document.getElementById('section-benevole').classList.remove('hidden');
            } else if (cat === 'information') {
                document.getElementById('section-information').classList.remove('hidden');
            }
        }
        document.getElementById('contact-nature')?.addEventListener('change', function(e) {
            document.getElementById('prev-id-container').classList.toggle('hidden', e.target.value !== 'Suivi');
        });

        async function submitFicheContact(e) {
            e.preventDefault();
            const payload = {
                type_permanence: 'classique',
                fiche_id: document.getElementById('contact-id').value,
                nature: document.getElementById('contact-nature').value,
                dossier_precedent: document.getElementById('contact-prev-id').value || '',
                categorie: document.getElementById('contact-categorie').value,
                nom: document.getElementById('contact-nom').value,
                telephone: document.getElementById('contact-tel').value,
                email: document.getElementById('contact-email').value,
                benevole: localStorage.getItem('lge_email'),
                start_session: localStorage.getItem('lge_start')
            };
            const cat = payload.categorie;
            if (cat === 'beneficiaire') {
                payload.situation_pro = document.getElementById('benef-situation-pro').value;
                payload.ressources = document.getElementById('benef-ressources').value;
                payload.enfants = document.getElementById('benef-enfants').value;
                payload.situation_admin = document.getElementById('benef-situation-admin').value;
                payload.demande = document.getElementById('benef-demande').value;
                payload.orientation = document.getElementById('benef-orientation').value;
                payload.urgence = document.getElementById('benef-urgence').value;
            } else if (cat === 'partenaire') {
                payload.structure = document.getElementById('partenaire-structure').value;
                payload.type_structure = document.getElementById('partenaire-type').value;
                payload.contact_partenaire = document.getElementById('partenaire-contact').value;
                payload.nature_partenariat = document.getElementById('partenaire-nature').value;
                // Nouveaux champs partenaires
                payload.partenariat_acte = document.getElementById('partenaire-acte').value;
                payload.partenariat_horaires = document.getElementById('partenaire-horaires').value;
                payload.partenariat_infos = document.getElementById('partenaire-infos').value;
            } else if (cat === 'benevole') {
                payload.age = document.getElementById('benevole-age').value;
                payload.competences = document.getElementById('benevole-competences').value;
                payload.disponibilites = document.getElementById('benevole-dispo').value;
                payload.mission = document.getElementById('benevole-mission').value;
            } else if (cat === 'information') {
                payload.sujet = document.getElementById('info-sujet').value;
                payload.reponse = document.getElementById('info-reponse').value;
            }
            try {
                const response = await fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
                const result = await response.text();
                console.log('R√©ponse serveur :', result);
                alert('Fiche enregistr√©e avec succ√®s !');
                closeFicheContact();
            } catch (err) {
                alert('Erreur lors de l\'envoi : ' + err.message);
            }
        }

        // ================== FICHE JURIDIQUE APPROFONDIE ==================
        function openFicheJuridique() {
            document.getElementById('juridique-id').value = 'JU-' + Date.now().toString().slice(-8);
            document.getElementById('modal-fiche-juridique').classList.remove('hidden');
        }
        function closeFicheJuridique() {
            document.getElementById('modal-fiche-juridique').classList.add('hidden');
        }
        document.getElementById('juridique-nature')?.addEventListener('change', function(e) {
            document.getElementById('juridique-prev-container').classList.toggle('hidden', e.target.value !== 'Suivi');
        });

        async function submitFicheJuridique(e) {
            e.preventDefault();
            const payload = {
                type_permanence: 'juridique', // Cl√© pour le script
                fiche_id: document.getElementById('juridique-id').value,
                nature: document.getElementById('juridique-nature').value,
                dossier_precedent: document.getElementById('juridique-prev-id').value || '',
                nom: document.getElementById('juridique-nom').value,
                prenom: document.getElementById('juridique-prenom').value,
                date_naissance: document.getElementById('juridique-date-naissance').value,
                lieu_naissance: document.getElementById('juridique-lieu-naissance').value,
                nationalite: document.getElementById('juridique-nationalite').value,
                pays_provenance: document.getElementById('juridique-pays-provenance').value,
                telephone: document.getElementById('juridique-tel').value,
                email: document.getElementById('juridique-email').value,
                date_rdv: document.getElementById('juridique-date-rdv').value,
                benevole_referent: document.getElementById('juridique-benevole-ref').value,
                numero_dossier: document.getElementById('juridique-numero-dossier').value,
                situation_logement: document.getElementById('juridique-logement').value,
                arrivee_avec_visa: document.getElementById('juridique-arrivee-visa').checked,
                arrivee_sans_visa: document.getElementById('juridique-arrivee-sans-visa').checked,
                date_entree: document.getElementById('juridique-date-entree').value,
                frontiere_entree: document.getElementById('juridique-frontiere').value,
                visas_passes: document.getElementById('juridique-visas-passes').value,
                conjoint_francais: document.getElementById('juridique-conjoint-fr').checked,
                conjoint_etranger_regulier: document.getElementById('juridique-conjoint-regulier').checked,
                conjoint_etranger_irregulier: document.getElementById('juridique-conjoint-irregulier').checked,
                date_mariage: document.getElementById('juridique-date-mariage').value,
                lieu_mariage: document.getElementById('juridique-lieu-mariage').value,
                a_des_enfants: document.getElementById('juridique-a-enfants').checked,
                enfants_nes_france: document.getElementById('juridique-enfants-france').checked,
                au_moins_un_enfant_francais: document.getElementById('juridique-enfant-francais').checked,
                enfants_details: document.getElementById('juridique-enfants-details').value,
                a_deja_eu_titre: document.getElementById('juridique-a-deja-titre').checked,
                titres_precedents: document.getElementById('juridique-titres-precedents').value,
                recipisse_en_cours: document.getElementById('juridique-recipisse').checked,
                numero_recipisse: document.getElementById('juridique-numero-recipisse').value,
                oqtf_recue: document.getElementById('juridique-oqtf').checked,
                date_oqtf: document.getElementById('juridique-date-oqtf').value,
                recours_exerce: document.getElementById('juridique-recours').checked,
                refus_sejour: document.getElementById('juridique-refus').checked,
                date_refus: document.getElementById('juridique-date-refus').value,
                motif_refus: document.getElementById('juridique-motif-refus').value,
                convocation_prefecture: document.getElementById('juridique-convocation').checked,
                date_convocation: document.getElementById('juridique-date-convocation').value,
                numero_dossier_prefecture: document.getElementById('juridique-numero-dossier-pref').value,
                autre_mesure: document.getElementById('juridique-autre-mesure').value,
                travail_declare: document.getElementById('juridique-travail-declare').checked,
                travail_non_declare: document.getElementById('juridique-travail-non-declare').checked,
                secteur_activite: document.getElementById('juridique-secteur').value,
                anciennete: document.getElementById('juridique-anciennete').value,
                employeur: document.getElementById('juridique-employeur').value,
                salaire: document.getElementById('juridique-salaire').value,
                temps_travail: document.getElementById('juridique-temps-travail').value,
                type_contrat: document.getElementById('juridique-type-contrat').value,
                promesse_embauche: document.getElementById('juridique-promesse').checked,
                preuves_travail: document.getElementById('juridique-preuves-travail').value,
                victime_violences: document.getElementById('juridique-victime-violences').checked,
                auteur_violences: document.getElementById('juridique-auteur-violences').value,
                nature_violences: document.getElementById('juridique-nature-violences').value,
                periode_violences: document.getElementById('juridique-periode-violences').value,
                plainte_deposee: document.getElementById('juridique-plainte').checked,
                lieu_plainte: document.getElementById('juridique-lieu-plainte').value,
                ordonnance_protection: document.getElementById('juridique-ordonnance').checked,
                juge_duree: document.getElementById('juridique-juge-duree').value,
                certificats_medicaux: document.getElementById('juridique-certificats').checked,
                dates_certificats: document.getElementById('juridique-dates-certificats').value,
                separee_auteur: document.getElementById('juridique-separee').checked,
                autres_preuves: document.getElementById('juridique-autres-preuves').value,
                suivi_association: document.getElementById('juridique-suivi-association').value,
                enfants_concernes: document.getElementById('juridique-enfants-concernes').checked,
                parent_enfant_francais: document.getElementById('juridique-parent-enfant-fr').checked,
                nom_enfant_francais: document.getElementById('juridique-nom-enfant-fr').value,
                numero_carte_enfant: document.getElementById('juridique-numero-carte-enfant').value,
                preuves_contribution: document.getElementById('juridique-preuves-contribution').value,
                presence_ancienne: document.getElementById('juridique-presence-ancienne').checked,
                preuves_presence: document.getElementById('juridique-preuves-presence').value,
                annees_manquantes: document.getElementById('juridique-annees-manquantes').value,
                raisons_sante: document.getElementById('juridique-raisons-sante').checked,
                maladie: document.getElementById('juridique-maladie').value,
                suivi_medical: document.getElementById('juridique-suivi-medical').value,
                certificat_impossibilite_soins: document.getElementById('juridique-certificat-impossibilite').checked,
                demande_asile: document.getElementById('juridique-demande-asile').checked,
                date_depot_asile: document.getElementById('juridique-date-depot-asile').value,
                decision_ofpra: document.getElementById('juridique-decision-ofpra').value,
                liens_familiaux_france: document.getElementById('juridique-liens-familiaux').value,
                integration: document.getElementById('juridique-integration').value,
                urgence_oqtf: document.getElementById('juridique-urgence-oqtf').checked,
                evaluation_danger: document.getElementById('juridique-evaluation-danger').value,
                danger_immediat: document.getElementById('juridique-danger-immediat').checked,
                mesures_protection: document.getElementById('juridique-mesures-protection').value,
                hebergement_urgence_necessaire: document.getElementById('juridique-hebergement-urgence').checked,
                contact_urgence: document.getElementById('juridique-contact-urgence').value,
                documents_resume: document.getElementById('juridique-documents-resume').value,
                resume_automatique: document.getElementById('juridique-resume-auto').value,
                orientation_proposee: document.getElementById('juridique-orientation').value,
                notes_complementaires: document.getElementById('juridique-notes').value,
                benevole_session: localStorage.getItem('lge_email'),
                start_session: localStorage.getItem('lge_start')
            };
            try {
                const response = await fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
                const result = await response.text();
                console.log('R√©ponse serveur :', result);
                alert('Fiche juridique enregistr√©e avec succ√®s !');
                closeFicheJuridique();
            } catch (err) {
                alert('Erreur : ' + err.message);
            }
        }

        // ================== FICHE MOBILE JURIDIQUE ==================
        function openFicheMobile() {
            document.getElementById('mobile-id').value = 'MJ-' + Date.now().toString().slice(-8);
            document.getElementById('modal-fiche-mobile').classList.remove('hidden');
        }
        function closeFicheMobile() {
            document.getElementById('modal-fiche-mobile').classList.add('hidden');
        }
        document.getElementById('mobile-nature')?.addEventListener('change', function(e) {
            document.getElementById('mobile-prev-container').classList.toggle('hidden', e.target.value !== 'Suivi');
        });
        async function submitFicheMobile(e) {
            e.preventDefault();
            const payload = {
                type_permanence: 'mobile_juridique',
                fiche_id: document.getElementById('mobile-id').value,
                nature: document.getElementById('mobile-nature').value,
                dossier_precedent: document.getElementById('mobile-prev-id').value || '',
                intervenant: document.getElementById('mobile-intervenant').value,
                nom: document.getElementById('mobile-nom').value,
                telephone: document.getElementById('mobile-tel').value,
                email: document.getElementById('mobile-email').value,
                situation_pro: document.getElementById('mobile-situation-pro').value,
                enfants: document.getElementById('mobile-enfants').value,
                situation_admin: document.getElementById('mobile-situation-admin').value,
                ressources: document.getElementById('mobile-ressources').value,
                theme: document.getElementById('mobile-theme').value,
                objet: document.getElementById('mobile-objet').value,
                analyse: document.getElementById('mobile-analyse').value,
                etapes: document.getElementById('mobile-etapes').value,
                aj: document.getElementById('mobile-aj').value,
                relais: document.getElementById('mobile-relais').value,
                urgence: document.getElementById('mobile-urgence').value,
                rgpd: document.getElementById('mobile-rgpd').value,
                benevole: localStorage.getItem('lge_email'),
                start_session: localStorage.getItem('lge_start')
            };
            try {
                const response = await fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
                const result = await response.text();
                console.log('R√©ponse serveur :', result);
                alert('Dossier transmis !');
                closeFicheMobile();
            } catch (err) {
                alert('Erreur : ' + err.message);
            }
        }

        // ================== FIN DE SESSION ==================
        function confirmerDeconnexion() {
            const start = new Date(localStorage.getItem('lge_start'));
            const end = new Date();
            const diff = Math.floor((end - start) / 1000);
            const heures = Math.floor(diff / 3600);
            const minutes = Math.floor((diff % 3600) / 60);
            const resume = `B√©n√©vole : ${localStorage.getItem('lge_email')}\nDur√©e : ${heures}h ${minutes}min\nD√©but : ${start.toLocaleString()}`;
            document.getElementById('logout-summary').innerText = resume;
            document.getElementById('modal-logout').classList.remove('hidden');
            fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({
                    type: 'fin_session',
                    email: localStorage.getItem('lge_email'),
                    start: start.toISOString(),
                    end: end.toISOString(),
                    duree: `${heures}h${minutes}`
                })
            }).catch(err => console.log('Fin session logg√©e'));
        }
        function fermerTout() {
            localStorage.clear();
            location.reload();
        }

        // ================== R√âINITIALISATION AU CHARGEMENT ==================
        window.onload = function() {
            updateClock();
            const email = localStorage.getItem('lge_email');
            if (email) {
                const start = new Date(localStorage.getItem('lge_start'));
                const type = localStorage.getItem('lge_type');
                lancerInterface(email, start, type);
            }
        };
    </script>
</body>
</html>
